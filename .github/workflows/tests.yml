name: tests
on: [push, pull_request]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # Buddy UT CLI robust installieren und in PATH einhÃ¤ngen
      # (wenn curl-Installer scheitert, probiere apt-Fallback)
      - name: Install Buddy UT CLI (non-fatal)
        continue-on-error: true
        shell: bash
        run: |
          set -euxo pipefail
          if ! curl -fsSL https://get.buddy.works/ut | bash; then
            echo "curl installer failed, trying apt fallback" >&2
            echo "deb [trusted=yes] https://es.buddy.works/bdy/apt-repo prod main" | sudo tee /etc/apt/sources.list.d/buddy-ut.list
            sudo apt-get update
            sudo apt-get install -y bdy
          fi
          echo "$HOME/.buddy/bin" >> "$GITHUB_PATH"
          echo "/usr/bin" >> "$GITHUB_PATH"   # falls apt den bdy nach /usr/bin gelegt hat
          command -v bdy || true
          bdy --version || true

      - name: Free 8080 (just in case)
        run: sudo fuser -k 8080/tcp || true

      - run: npm ci || npm i

      - name: Install Cypress deps
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Vitest + Upload
        env:
          BUDDY_UT_TOKEN: ${{ secrets.BUDDY_UT_TOKEN }}
        run: npm run test:ci

      - name: Cypress + Upload
        env:
          BUDDY_UT_TOKEN: ${{ secrets.BUDDY_UT_TOKEN }}
        run: npm run cy:ci

      - name: Upload JUnit artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-reports
          path: reports/*.xml
          if-no-files-found: warn
